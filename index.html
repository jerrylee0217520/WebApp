<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>èªéŸ³è¨˜å¸³ï¼ˆFirebaseï¼‰</title>
  <meta name="theme-color" content="#0b1020" />
  <link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAB8y0H7AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABNklEQVR42u3RMQEAIAwAsT9fM2lQk1Qm2kB2K2pJrQ9w0gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHgN4Wm9xk8wHq3sJgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP8B0k0Yx8o3P8oAAAAASUVORK5CYII="/>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%230b1020'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='34' fill='%23e8ecff'%3E$%3C/text%3E%3C/svg%3E" />
  <style>
    :root { --bg:#0b1020; --card:#141a2e; --text:#e8ecff; --muted:#9aa3b2; --accent:#6aa5ff; --ok:#49c46b; --warn:#ffb951; --err:#ff6a6a; }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;background:linear-gradient(180deg,#0b1020,#0e1530);padding-bottom:env(safe-area-inset-bottom);} 
    header{position:sticky;top:0;background:rgba(11,16,32,.85);backdrop-filter:blur(6px);border-bottom:1px solid #1e2745;z-index:10;padding-top:env(safe-area-inset-top);}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid #1e2745;border-radius:16px;padding:16px;color:var(--text);box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .grow{flex:1 1 320px}
    h1{font-size:20px;margin:0;color:var(--text)}
    h2{font-size:18px;margin:8px 0}
    label{display:block;color:var(--muted);margin-top:8px;font-size:13px}
    input,select,textarea{width:100%;padding:10px 12px;background:#0f1529;border:1px solid #233056;border-radius:12px;color:var(--text)}
    textarea{min-height:80px;resize:vertical}
    button{appearance:none;border:1px solid #233056;background:#1a2441;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    button:hover{filter:brightness(1.1)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .primary{background:linear-gradient(180deg,#2b66ff,#1b46bf);border-color:#2b66ff}
    .ok{background:linear-gradient(180deg,#2a8f51,#1e6f3e);border-color:#2a8f51}
    .warn{background:linear-gradient(180deg,#ce8b2d,#a56b1e);border-color:#ce8b2d}
    .err{background:linear-gradient(180deg,#c83f3f,#9a2c2c);border-color:#c83f3f}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid #2a355c;border-radius:999px;background:#0e1530;color:#aeb7d6;font-size:12px}
    .status-dot{width:8px;height:8px;border-radius:50%}
    .dot-ok{background:var(--ok)} .dot-off{background:#777}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #1f294a;text-align:left;color:#cfd7f0}
    th{color:#8fa1d0;font-weight:600}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New",monospace;background:#0f1529;border:1px solid #233056;border-radius:10px;padding:10px;white-space:pre-wrap}
    details{border:1px solid #233056;border-radius:12px;padding:12px;background:#0f1529}
    summary{cursor:pointer;color:#a7b6e8}
    footer{color:#7f8db2;padding:30px 0}
    small{color:#93a0c7}

    .modal {position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
    .modal .panel {background:var(--card);border:1px solid #233056;border-radius:16px;padding:16px;max-width:680px;width:92%}
  </style>
</head>
<body>
  <header>
    <div class="container row" style="justify-content:space-between;align-items:center">
      <h1>ğŸ™ï¸ èªéŸ³è¨˜å¸³ï¼ˆFirebaseï¼‰</h1>
      <div class="row" style="align-items:center;gap:8px">
        <span class="pill"><span id="voiceDot" class="status-dot dot-off"></span> èªéŸ³</span>
        <span class="pill"><span id="authDot" class="status-dot dot-off"></span> ç™»å…¥</span>
        <button id="btnSignIn">Google ç™»å…¥</button>
        <button id="btnSignOut" style="display:none">ç™»å‡º</button>
        <button id="btnSetup" class="warn">âš™ï¸ è¨­å®š</button>
      </div>
    </div>
  </header>

  <main class="container grid" style="margin-top:14px">
    <section class="card grid grid-2">
      <div class="grow">
        <h2>1) èªéŸ³ / æ–‡å­—è¼¸å…¥</h2>
        <div class="row">
          <button class="primary" id="btnToggleRec">é–‹å§‹éŒ„éŸ³</button>
          <button id="btnClear">æ¸…ç©º</button>
          <button id="btnParse">ğŸ§  è§£æ</button>
          <button class="ok" id="btnSave" disabled>âœ… å„²å­˜</button>
        </div>
        <label for="lang">è¾¨è­˜èªè¨€</label>
        <select id="lang">
          <option value="zh-TW">ä¸­æ–‡ï¼ˆå°ç£ï¼‰</option>
          <option value="zh-HK">ä¸­æ–‡ï¼ˆé¦™æ¸¯ï¼‰</option>
          <option value="zh-CN">ä¸­æ–‡ï¼ˆä¸­åœ‹ï¼‰</option>
          <option value="en-US">English (US)</option>
        </select>
        <label for="raw">èªéŸ³è½‰æ–‡å­— / æ‰‹å‹•è¼¸å…¥</label>
        <textarea id="raw" inputmode="text" autocapitalize="off" autocomplete="off" autocorrect="off"></textarea>
        <small class="muted" id="iosHint" style="display:none">ğŸ’¡ iPhoneï¼šè‹¥ä¸Šæ–¹ã€Œé–‹å§‹éŒ„éŸ³ã€ä¸å¯ç”¨ï¼Œè«‹åœ¨éµç›¤ä¸Šé»éº¥å…‹é¢¨ä½¿ç”¨åŸç”ŸèªéŸ³è¼¸å…¥ã€‚</small>
        <small class="muted">Safari iOS å° Web Speech æ”¯æ´æœ‰é™ï¼›è‹¥ç„¡æ³•éŒ„éŸ³ï¼Œè«‹æ”¹ç”¨æ‰‹å‹•è¼¸å…¥ã€‚</small>
      </div>

      <div class="grow">
        <h2>2) è§£æçµæœï¼ˆå¯ç·¨ä¿®ï¼‰</h2>
        <div class="grid grid-3">
          <div>
            <label>é‡‘é¡ (TWD)</label>
            <input id="amount" type="number" step="0.01" placeholder="0"/>
          </div>
          <div>
            <label>æ—¥æœŸ</label>
            <input id="date" type="date"/>
          </div>
          <div>
            <label>æ™‚é–“</label>
            <input id="time" type="time"/>
          </div>
        </div>
        <div class="grid grid-3">
          <div>
            <label>åº—å®¶ / å°è±¡</label>
            <input id="merchant" placeholder="7-11"/>
          </div>
          <div>
            <label>åˆ†é¡</label>
            <input id="category" placeholder="é¤é£² / äº¤é€š / è¨‚é–±â€¦"/>
          </div>
          <div>
            <label>ä»˜æ¬¾æ–¹å¼</label>
            <input id="payment" placeholder="ç¾é‡‘ / ä¿¡ç”¨å¡ / LINE Payâ€¦"/>
          </div>
        </div>
        <label>å‚™è¨» / åŸå¥</label>
        <textarea id="note"></textarea>
      </div>
    </section>

    <section class="card">
      <h2>3) æŸ¥è©¢èˆ‡åŒ¯å‡º</h2>
      <div class="row" style="align-items:end">
        <div>
          <label>æœˆä»½</label>
          <input id="month" type="month"/>
        </div>
        <button id="btnQuery">ğŸ” è®€å–æœ¬æœˆ</button>
        <button id="btnExport">â¬‡ï¸ åŒ¯å‡ºCSV</button>
        <div class="pill"><span>æœ¬æœˆåˆè¨ˆï¼š</span><strong id="sumMonth">0</strong> å…ƒ</div>
      </div>
      <div style="overflow:auto; max-height:380px; margin-top:10px">
        <table>
          <thead>
            <tr><th>æ—¥æœŸæ™‚é–“</th><th>åº—å®¶</th><th>åˆ†é¡</th><th class="right">é‡‘é¡</th><th>ä»˜æ¬¾</th><th>å‚™è¨»</th></tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>å¿«é€Ÿèªªæ˜</h2>
      <ol>
        <li>ç¬¬ä¸€æ¬¡ä½¿ç”¨è«‹é»å³ä¸Š <strong>âš™ï¸ è¨­å®š</strong>ï¼Œè²¼ä¸Š Firebase Configï¼ˆåªéœ€ä¸€æ¬¡ï¼Œæœƒå­˜åˆ°æœ¬æ©Ÿï¼‰ã€‚</li>
        <li>Firestore è¦å‰‡ï¼šå·²ç‚º <code>expenses</code> é›†åˆåšã€Œæœ¬äººå¯è®€å¯«ã€ï¼›å…¶ä»–ä½ çš„æ—¢æœ‰é›†åˆç¶­æŒã€Œå·²ç™»å…¥å¯è®€å¯«ã€ã€‚</li>
        <li>ç™»å…¥ Google å¾Œå³å¯èªéŸ³æˆ–æ‰‹å‹•è¼¸å…¥ï¼ŒæŒ‰ã€ŒğŸ§  è§£æã€â†’ã€Œâœ… å„²å­˜ã€ã€‚</li>
      </ol>
      <details>
        <summary>é»æˆ‘å±•é–‹ï¼šå»ºè­° Firestore è¦å‰‡ï¼ˆå«ç®¡ç†è€… UIDï¼‰</summary>
        <pre class="code">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isAdmin() {
      return request.auth != null && request.auth.uid in ['KcaxVmcqI3RzxWdhCl2dhVGPxti1'];
    }
    match /expenses/{id} {
      allow read: if isSignedIn() && request.auth.uid == resource.data.uid;
      allow create: if isSignedIn()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.keys().hasAll(['uid','amount','currency','txDate','dateKey'])
        && request.resource.data.amount is number
        && request.resource.data.currency is string
        && request.resource.data.txDate is timestamp
        && request.resource.data.dateKey is string;
      allow update, delete: if isSignedIn() && (request.auth.uid == resource.data.uid || isAdmin());
    }

    match /parking_records/{recordId} { allow read, write: if isSignedIn(); }
    match /daily_logs/{logId} { allow read, write: if isSignedIn(); }
    match /app_config/{docId} { allow read, write: if isSignedIn(); }
    match /units/{unitId} { allow read, write: if isSignedIn(); }
    match /inspection_logs/{logId} { allow read, write: if isSignedIn(); }
    match /unit_parking_spots/{unitId} { allow read, write: if isSignedIn(); }
    match /artifacts/{appId}/public/data/usage_logs/{logId} { allow read, write: if isSignedIn(); }
    match /admins/{uid} { allow read, write: if isSignedIn(); }
    match /artifacts/{appId}/public/{document=**} { allow read: if true; }
  }
}
</pre>
      </details>
    </section>

    <footer class="container">
      <small>æç¤ºèªä¾‹ï¼š
        ã€Œä»Šå¤©å…¨è¯è²·èœ 385 å…ƒåˆ·è¯é‚¦å¡ã€ã€
        ã€Œæ˜¨å¤©åœ¨ 7-11 å’–å•¡ 55 å…ƒç”¨ LINE Payã€ã€
        ã€Œ8/3 Uber 220 äº¤é€šã€ã€‚
      </small>
    </footer>
  </main>

  <div class="modal" id="setupModal">
    <div class="panel">
      <h2 style="margin-top:0">âš™ï¸ Firebase è¨­å®š</h2>
      <p class="muted">å¯ç›´æ¥è²¼ä¸Š Firebase Console è¤‡è£½çš„ <strong>config JSON</strong>ï¼ˆå« apiKey / projectId ç­‰ï¼‰ï¼Œæˆ–é€æ¬„å¡«å¯«ã€‚æ­¤è³‡è¨Šåªä¿å­˜åœ¨ä½ çš„ç€è¦½å™¨æœ¬æ©Ÿã€‚</p>
      <textarea id="cfgJson" class="code" placeholder='{
  "apiKey": "...",
  "authDomain": "...",
  "projectId": "...",
  "storageBucket": "...",
  "messagingSenderId": "...",
  "appId": "..."
}'></textarea>
      <div class="grid grid-3" style="margin-top:8px">
        <div><label>apiKey</label><input id="cfg_apiKey"></div>
        <div><label>authDomain</label><input id="cfg_authDomain"></div>
        <div><label>projectId</label><input id="cfg_projectId"></div>
        <div><label>storageBucket</label><input id="cfg_storageBucket"></div>
        <div><label>messagingSenderId</label><input id="cfg_msg"></div>
        <div><label>appId</label><input id="cfg_appId"></div>
      </div>
      <div class="row" style="margin-top:12px;justify-content:flex-end">
        <button id="btnCfgCancel">å–æ¶ˆ</button>
        <button class="ok" id="btnCfgSave">ğŸ’¾ å„²å­˜ä¸¦åˆå§‹åŒ–</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
  // å…ˆæŠ“åˆ°éœ€è¦ç”¨åˆ°çš„ç¯€é»ï¼Œé¿å… showSetup æ—©æ–¼å®£å‘Šå°è‡´ Script error
  const setupModal = document.getElementById('setupModal');
  const cfgJson = document.getElementById('cfgJson');
  const cfg_apiKey = document.getElementById('cfg_apiKey');
  const cfg_authDomain = document.getElementById('cfg_authDomain');
  const cfg_projectId = document.getElementById('cfg_projectId');
  const cfg_storageBucket = document.getElementById('cfg_storageBucket');
  const cfg_msg = document.getElementById('cfg_msg');
  const cfg_appId = document.getElementById('cfg_appId');

  const LS_KEY = 'voice-expense-firebase-config';
  function readCfg(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch(e){ return {}; } }
  function writeCfg(cfg){ localStorage.setItem(LS_KEY, JSON.stringify(cfg||{})); }
  function applyCfgToFields(cfg){
    cfg_apiKey.value = cfg.apiKey||'';
    cfg_authDomain.value = cfg.authDomain||'';
    cfg_projectId.value = cfg.projectId||'';
    cfg_storageBucket.value = cfg.storageBucket||'';
    cfg_msg.value = cfg.messagingSenderId||'';
    cfg_appId.value = cfg.appId||'';
    cfgJson.value = Object.keys(cfg).length? JSON.stringify(cfg,null,2): '';
  }
  function collectCfg(){
    let cfg = {};
    const raw = cfgJson.value.trim();
    if (raw){ try{ cfg = JSON.parse(raw); }catch(e){ alert('JSON æ ¼å¼éŒ¯èª¤'); return null; } }
    cfg.apiKey = cfg.apiKey || cfg_apiKey.value.trim();
    cfg.authDomain = cfg.authDomain || cfg_authDomain.value.trim();
    cfg.projectId = cfg.projectId || cfg_projectId.value.trim();
    cfg.storageBucket = cfg.storageBucket || cfg_storageBucket.value.trim();
    cfg.messagingSenderId = cfg.messagingSenderId || cfg_msg.value.trim();
    cfg.appId = cfg.appId || cfg_appId.value.trim();
    if (!cfg.apiKey || !cfg.projectId || !cfg.appId){ alert('è‡³å°‘éœ€å¡« apiKey / projectId / appId'); return null; }
    return cfg;
  }
  function showSetup(on){ if (!setupModal) return; setupModal.style.display = on? 'flex':'none'; }
  const cfg0 = readCfg();
  if (!cfg0.apiKey){ showSetup(true); }
  btnSetup.onclick = ()=>{ applyCfgToFields(readCfg()); showSetup(true); };
  btnCfgCancel.onclick = ()=> showSetup(false);
  btnCfgSave.onclick = ()=>{ const cfg = collectCfg(); if (!cfg) return; writeCfg(cfg); location.reload(); };

  (function initFirebase(){ const cfg = readCfg(); if (!cfg.apiKey){ return; } firebase.initializeApp(cfg); })();
  function assertApp(){ if (!firebase.apps.length){ alert('è«‹å…ˆé»å³ä¸Šã€Œè¨­å®šã€ï¼Œè²¼ä¸Š Firebase Config'); return false; } return true; }

  const $ = (s)=>document.querySelector(s);
  const btnSignIn = $('#btnSignIn');
  const btnSignOut = $('#btnSignOut');
  const authDot = $('#authDot');
  const voiceDot = $('#voiceDot');
  const btnToggleRec = $('#btnToggleRec');
  const btnClear = $('#btnClear');
  const btnParse = $('#btnParse');
  const btnSave = $('#btnSave');
  const raw = $('#raw');
  const langSel = $('#lang');
  const amount = $('#amount');
  const date = $('#date');
  const time = $('#time');
  const merchant = $('#merchant');
  const category = $('#category');
  const payment = $('#payment');
  const note = $('#note');
  const rows = $('#rows');
  const month = $('#month');
  const btnQuery = $('#btnQuery');
  const btnExport = $('#btnExport');
  const sumMonth = $('#sumMonth');

  btnSignIn.onclick = async()=>{ if (!assertApp()) return; const provider = new firebase.auth.GoogleAuthProvider(); try{ const isIOS = /iP(hone|ad|od)/i.test(navigator.userAgent); if (isIOS) { await firebase.auth().signInWithRedirect(provider); } else { await firebase.auth().signInWithPopup(provider); } }catch(err){ console.error(err); alert('ç™»å…¥å¤±æ•—ï¼š'+err.message); } };
  btnSignOut.onclick = ()=> firebase.auth().signOut();
  firebase.auth().onAuthStateChanged(u=>{ const on = !!u; const authDot = document.getElementById('authDot'); const btnSignIn = document.getElementById('btnSignIn'); const btnSignOut = document.getElementById('btnSignOut'); const btnSave = document.getElementById('btnSave'); if (authDot) authDot.className = 'status-dot ' + (on? 'dot-ok':'dot-off'); if (btnSignIn) btnSignIn.style.display = on? 'none':'inline-block'; if (btnSignOut) btnSignOut.style.display = on? 'inline-block':'none'; if (btnSave) btnSave.disabled = !on || !firebase.apps.length; if (on && firebase.apps.length) queryCurrentMonth(); });

  // iOS ç„¡ SpeechRecognition æ™‚ï¼Œéš±è—éŒ„éŸ³éµä¸¦é¡¯ç¤ºæç¤º
  (function(){ const SR0 = window.SpeechRecognition || window.webkitSpeechRecognition; if (/iP(hone|ad|od)/i.test(navigator.userAgent) && !SR0){ const b=document.getElementById('btnToggleRec'); if(b) b.style.display='none'; const hint=document.getElementById('iosHint'); if(hint) hint.style.display='block'; } })();
  let rec; let recognizing = false; let interim = '';
  function setupRecognition(){ const SR = window.SpeechRecognition || window.webkitSpeechRecognition; if (!SR) return null; const r = new SR(); r.lang = langSel.value || 'zh-TW'; r.continuous = true; r.interimResults = true; r.onstart = ()=>{recognizing = true; voiceDot.className='status-dot dot-ok'; btnToggleRec.textContent='åœæ­¢éŒ„éŸ³'}; r.onend = ()=>{recognizing = false; voiceDot.className='status-dot dot-off'; btnToggleRec.textContent='é–‹å§‹éŒ„éŸ³'}; r.onresult = (e)=>{ let finalText = ''; for (let i=e.resultIndex;i<e.results.length;i++){ const t = e.results[i][0].transcript; if (e.results[i].isFinal) finalText += t + ' '; else interim = t; } raw.value = (raw.value + ' ' + finalText).trim(); }; r.onerror = (e)=>console.warn('Speech error', e); return r; }
  btnToggleRec.onclick = ()=>{ if (!rec) rec = setupRecognition(); if (!rec){ alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œè«‹æ”¹ç”¨æ‰‹å‹•è¼¸å…¥'); return; } if (recognizing) rec.stop(); else { rec.lang = langSel.value; rec.start(); } };
  btnClear.onclick = ()=>{ raw.value=''; };

  function toDateKey(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
  function parseWhen(text){ text = text.trim(); const now = new Date(); const taipeiNow = new Date(now.toLocaleString('en-US',{timeZone:'Asia/Taipei'})); let d = new Date(taipeiNow); if (/å‰å¤©/.test(text)) d.setDate(d.getDate()-2); else if (/(æ˜¨|æ˜¨å¤©|æ˜¨æ—¥)/.test(text)) d.setDate(d.getDate()-1); else if (/ä»Šå¤©|ä»Šæ—¥|å‰›å‰›|å‰›æ‰/.test(text)) { } else { const mdy = text.match(/(20\d{2})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/); const md = text.match(/(\d{1,2})[\/\-\.æœˆ](\d{1,2})(?:æ—¥)?/); if (mdy){ d = new Date(`${mdy[1]}-${mdy[2]}-${mdy[3]}T12:00:00+08:00`); } else if (md){ const Y = taipeiNow.getFullYear(); d = new Date(`${Y}-${md[1]}-${md[2]}T12:00:00+08:00`); } } const hm = text.match(/(\d{1,2})[:ï¼š](\d{2})/); if (hm){ d.setHours(parseInt(hm[1],10), parseInt(hm[2],10), 0, 0); } return d; }
  function parseAmount(text){ const m1 = text.match(/(-?\d+[\.,]?\d*)\s*(?:å…ƒ|å¡Š|åœ“)/); if (m1) return parseFloat(m1[1].replace(',','')); const m2 = text.match(/(?:NT\$?|æ–°å°å¹£)\s*(-?\d+[\.,]?\d*)/i); if (m2) return parseFloat(m2[1].replace(',','')); const nums = [...text.matchAll(/\b(\d{1,6})(?:\.\d{1,2})?\b/g)].map(x=>x[0]); if (nums.length){ return parseFloat(nums[nums.length-1]); } return NaN; }
  const categoryRules = [ {k:/å’–å•¡|é¤|åƒ|ä¾¿ç•¶|æ—©åˆé¤|æ™šé¤|éº¥ç•¶å‹|è‚¯å¾·åŸº|æ˜Ÿå·´å…‹|ç«é‹|é¹½é…¥é›|é£²æ–™|çå¥¶|æ‰‹æ–/i,c:'é¤é£²'}, {k:/æ·é‹|å…¬è»Š|è¨ˆç¨‹è»Š|uber|uber\s*eat|æ©Ÿè»Š|æ²¹éŒ¢|åŠ æ²¹|åœè»Š|é«˜éµ|å°éµ|å®¢é‹/i,c:'äº¤é€š'}, {k:/7[-â€”]?11|7\s*11|å…¨å®¶|å…¨è¯|å®¶æ¨‚ç¦|costco|é ‚å¥½|ç¾å»‰ç¤¾|æ„›è²·|è¶…å¸‚|ä¾¿åˆ©å•†åº—/i,c:'é›œè²¨'}, {k:/æˆ¿ç§Ÿ|ç§Ÿé‡‘|ç®¡ç†è²»|æ°´è²»|é›»è²»|ç“¦æ–¯|ç¬¬å››å°|ç¶²è·¯|å…‰çº–/i,c:'å±…å®¶'}, {k:/ç‰™é†«|é†«é™¢|è—¥å±€|å¥ä¿|æ›è™Ÿ|é«”æª¢|çœ‹è¨º|è—¥|å£ç½©/i,c:'é†«ç™‚'}, {k:/è¡£|è¤²|é‹|å¤–å¥—|uniqlo|zara|muji|ç„¡å°/i,c:'æœé£¾'}, {k:/æ›¸|æ›¸åº—|é›œèªŒ|èª²ç¨‹|å­¸è²»|è£œç¿’|æ•™æ/i,c:'æ•™è‚²'}, {k:/netflix|spotify|apple\s*music|youtube\s*premium|è¨‚é–±/i,c:'è¨‚é–±'}, {k:/ç¦®ç‰©|ç´…åŒ…|ææ¬¾|å¥‰ç»/i,c:'äººæƒ…'} ];
  function detectCategory(text){ for (const r of categoryRules){ if (r.k.test(text)) return r.c; } return ''; }
  function detectPayment(text){ if (/line\s*pay/i.test(text)) return 'LINE Pay'; if (/è¡—å£|JKOPAY/i.test(text)) return 'è¡—å£æ”¯ä»˜'; if (/apple\s*pay/i.test(text)) return 'Apple Pay'; if (/google\s*pay/i.test(text)) return 'Google Pay'; if (/ç¾é‡‘/.test(text)) return 'ç¾é‡‘'; if (/åˆ·å¡|ä¿¡ç”¨å¡|visa|master|jcb/i.test(text)) return 'ä¿¡ç”¨å¡'; if (/è½‰å¸³|åŒ¯æ¬¾/.test(text)) return 'è½‰å¸³'; return ''; }
  function detectMerchant(text){ const m = text.match(/åœ¨([\w\u4e00-\u9fa5\-\s]+?)(?:è²·|åˆ·|ä»˜|æ¶ˆè²»|é»|å–|åƒ)/); if (m) return m[1].trim(); const shops = ['7-11','7 11','å…¨å®¶','å…¨è¯','å®¶æ¨‚ç¦','Costco','æ˜Ÿå·´å…‹','éº¥ç•¶å‹','è‚¯å¾·åŸº','é¹½é…¥é›','Uber','Ubereats','Uber eats','Mos','Subway','IKEA']; for (const s of shops){ if (text.toLowerCase().includes(s.toLowerCase())) return s.replace(/\s+/g,''); } return ''; }
  function parseAll(){ const t = raw.value.trim(); if (!t){ alert('è«‹å…ˆè¼¸å…¥èªå¥'); return; } const d = parseWhen(t); const amt = parseAmount(t); const mer = detectMerchant(t); const cat = detectCategory(t); const pay = detectPayment(t); if (!isNaN(amt)) amount.value = amt.toFixed(0); const dk = toDateKey(d); date.value = dk; const hh = String(d.getHours()).padStart(2,'0'); const mm = String(d.getMinutes()).padStart(2,'0'); time.value = `${hh}:${mm}`; merchant.value = mer; category.value = cat; payment.value = pay; note.value = t; btnSave.disabled = !firebase.auth().currentUser; }
  btnParse.onclick = parseAll;

  function toTaipeiDate(dateStr, timeStr){ const d = new Date(`${dateStr||new Date().toISOString().slice(0,10)}T${timeStr||'12:00'}:00+08:00`); return d; }
  btnSave.onclick = async()=>{ if (!firebase.auth().currentUser) { alert('è«‹å…ˆç™»å…¥'); return; } const uid = firebase.auth().currentUser.uid; const amt = parseFloat(amount.value||'0'); if (!amt || isNaN(amt)) { alert('è«‹è¼¸å…¥é‡‘é¡'); return; } const d = toTaipeiDate(date.value, time.value); const docData = { uid, amount: amt, currency: 'TWD', txDate: firebase.firestore.Timestamp.fromDate(d), dateKey: toDateKey(d), year: d.getFullYear(), month: d.getMonth()+1, day: d.getDate(), merchant: merchant.value||'', category: category.value||'', payment: payment.value||'', note: note.value||'', source: 'voice' }; await firebase.firestore().collection('expenses').add({ ...docData, createdAt: firebase.firestore.FieldValue.serverTimestamp(), updatedAt: firebase.firestore.FieldValue.serverTimestamp(), }); raw.value=''; amount.value=''; merchant.value=''; category.value=''; payment.value=''; note.value=''; queryCurrentMonth(); alert('å·²å„²å­˜'); };

  function monthRange(ym){ const [y,m] = ym.split('-').map(x=>parseInt(x,10)); const start = new Date(Date.UTC(y,m-1,1,0,0,0)); const end = new Date(Date.UTC(y,m,1,0,0,0)); const fmt = (d)=> d.toISOString().slice(0,10); return {startKey: fmt(start), endKey: fmt(end)}; }
  async function queryByMonth(ym){ if (!firebase.auth().currentUser) return []; const uid = firebase.auth().currentUser.uid; const {startKey,endKey} = monthRange(ym); const snap = await firebase.firestore().collection('expenses').where('uid','==',uid).where('dateKey','>=',startKey).where('dateKey','<',endKey).orderBy('dateKey','desc').orderBy('txDate','desc').get(); return snap.docs.map(d=>({id:d.id,...d.data()})); }
  function renderRows(list){ rows.innerHTML = ''; let sum = 0; for (const it of list){ sum += (it.amount||0); const dt = it.txDate?.toDate?.() || new Date(); const when = `${toDateKey(dt)} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`; const tr = document.createElement('tr'); tr.innerHTML = `<td>${when}</td><td>${it.merchant||''}</td><td>${it.category||''}</td><td class="right">${(it.amount||0).toLocaleString('zh-TW')}</td><td>${it.payment||''}</td><td class="muted">${(it.note||'').slice(0,60)}</td>`; rows.appendChild(tr); } sumMonth.textContent = sum.toLocaleString('zh-TW'); }
  async function queryCurrentMonth(){ const now = new Date(); const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; month.value = ym; const list = await queryByMonth(ym); renderRows(list); }
  btnQuery.onclick = async()=>{ if (!month.value) { alert('è«‹å…ˆé¸æ“‡æœˆä»½'); return; } const list = await queryByMonth(month.value); renderRows(list); };
  btnExport.onclick = async()=>{ if (!month.value) { alert('è«‹å…ˆé¸æ“‡æœˆä»½'); return; } const list = await queryByMonth(month.value); const header = ['æ—¥æœŸ','æ™‚é–“','é‡‘é¡','å¹£åˆ¥','åˆ†é¡','å•†å®¶','ä»˜æ¬¾æ–¹å¼','å‚™è¨»']; const lines = [header.join(',')]; for (const it of list){ const dt = it.txDate?.toDate?.() || new Date(); const dateKey = toDateKey(dt); const hh = String(dt.getHours()).padStart(2,'0'); const mm = String(dt.getMinutes()).padStart(2,'0'); const row = [dateKey, `${hh}:${mm}`, it.amount, it.currency||'TWD', (it.category||''), (it.merchant||''), (it.payment||''), (it.note||'')].map(x=>`"${String(x).replace(/"/g,'""')}"`).join(','); lines.push(row); } const csv = new Blob(["\ufeff"+lines.join('\n')], {type:'text/csv;charset=utf-8;'}); const a = document.createElement('a'); a.href = URL.createObjectURL(csv); a.download = `expenses_${month.value}.csv`; a.click(); };

  (function initMonth(){ const now = new Date(); month.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; })();
  // ==== PWAï¼šå‹•æ…‹å»ºç«‹ Manifestï¼ˆå–®æª”éƒ¨ç½²ç”¨ï¼‰====
  (function createManifest(){
    try{
      const manifest = {
        name: "èªéŸ³è¨˜å¸³ï¼ˆFirebaseï¼‰",
        short_name: "èªéŸ³è¨˜å¸³",
        description: "é›¢ç·šå¯ç”¨ã€æ”¯æ´ iOS çš„èªéŸ³è¨˜å¸³ PWA",
        start_url: ".",
        scope: ".",
        display: "standalone",
        background_color: "#0b1020",
        theme_color: "#0b1020",
        icons: [
          { src: document.querySelector("link[rel='apple-touch-icon']").href, sizes: "180x180", type: "image/png", purpose:"any" },
          { src: document.querySelector("link[rel='icon']").href, sizes: "64x64", type: "image/svg+xml", purpose:"any" }
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
      const url = URL.createObjectURL(blob);
      let link = document.querySelector('link[rel="manifest"]');
      if (!link){ link = document.createElement('link'); link.rel = 'manifest'; document.head.appendChild(link); }
      link.href = url;
    }catch(e){ console.warn('manifest å»ºç«‹å¤±æ•—', e); }
  })();

  // ==== PWAï¼šService Workerï¼ˆå–®æª”éƒ¨ç½²ï¼šä»¥ Blob URL è¨»å†Šï¼›è‹¥ç’°å¢ƒé™åˆ¶å‰‡è‡ªå‹•è·³éï¼‰====
  (function registerSW(){
    if (!('serviceWorker' in navigator)) return;
    const swCode = `
      const CACHE = 'vepwa-v1';
      const ASSETS = [
        './',
        location.pathname,
        'https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js',
        'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js',
        'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js'
      ];
      self.addEventListener('install', e => {
        e.waitUntil((async ()=>{
          const c = await caches.open(CACHE);
          try{ await c.addAll(ASSETS); }catch(err){ /* æœ‰äº›ä¾†æºå¯èƒ½ç„¡æ³•å¿«å–ï¼Œå¿½ç•¥ */ }
          self.skipWaiting();
        })());
      });
      self.addEventListener('activate', e => {
        e.waitUntil((async()=>{
          const keys = await caches.keys();
          await Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)));
          self.clients.claim();
        })());
      });
      self.addEventListener('fetch', e => {
        const req = e.request;
        const url = new URL(req.url);
        if (req.method !== 'GET') return;
        // å°å°è¦½èˆ‡éœæ…‹è³‡æºåš cache-firstï¼›å…¶ä»–èµ°ç¶²è·¯
        if (req.mode === 'navigate' || ASSETS.some(a=>url.href.endsWith(a) || url.href===a)){
          e.respondWith((async()=>{
            const hit = await caches.match(req, {ignoreSearch:true});
            if (hit) return hit;
            try{
              const res = await fetch(req);
              const c = await caches.open(CACHE); c.put(req, res.clone());
              return res;
            }catch(err){
              return new Response('<!doctype html><meta charset="utf-8"><title>é›¢ç·šä¸­</title><body style="font-family:sans-serif;padding:20px">é›¢ç·šä½¿ç”¨ä¸­ï¼ˆå·²å¿«å–çš„é é¢å¯ç”¨ï¼‰ã€‚</body>', {headers:{'Content-Type':'text/html;charset=utf-8'}});
            }
          })());
        }
      });
    `;
    try{
      const url = URL.createObjectURL(new Blob([swCode], {type:'text/javascript'}));
      navigator.serviceWorker.register(url).then(()=>{
        console.log('PWA Service Worker è¨»å†Šå®Œæˆ');
      }).catch(err=>{
        console.warn('ç„¡æ³•ä»¥ Blob è¨»å†Š SWï¼ˆå¯èƒ½ç’°å¢ƒé™åˆ¶ï¼‰', err);
      });
    }catch(err){ console.warn('å»ºç«‹ SW å¤±æ•—', err); }
  })();

  // ==== PWAï¼šå®‰è£æç¤ºï¼ˆAndroid/æ¡Œé¢å¯è§¸ç™¼ï¼›iOS è«‹ç”¨åŠ å…¥ä¸»ç•«é¢ï¼‰====
  let deferredPrompt = null;
  window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; showInstallButton(true); });
  function showInstallButton(on){
    let btn = document.getElementById('btnInstall');
    if (!btn){ btn = document.createElement('button'); btn.id='btnInstall'; btn.textContent='ğŸ“² å®‰è£åˆ°ä¸»ç•«é¢'; btn.className='ok';
      const headerRow = document.querySelector('header .row'); headerRow && headerRow.appendChild(btn);
    }
    btn.style.display = on? 'inline-block':'none';
    btn.onclick = async()=>{ if (!deferredPrompt){
        alert('iPhoneï¼šè«‹ç”¨ Safari çš„åˆ†äº« â†’ åŠ å…¥ä¸»ç•«é¢'); return;
      }
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice; // accepted / dismissed
      deferredPrompt = null; showInstallButton(false);
      console.log('A2HS outcome:', outcome);
    };
  }
  // iOS æç¤º
  if (/iP(hone|ad|od)/i.test(navigator.userAgent)){
    showInstallButton(true);
    const btn = document.getElementById('btnInstall');
    if (btn) btn.onclick = ()=> alert('åœ¨ Safariï¼šé»åˆ†äº«æŒ‰éˆ• â†’ åŠ å…¥ä¸»ç•«é¢ï¼Œå³å¯ç•¶ App ä½¿ç”¨');
  }
  </script>
</body>
</html>
