<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b1020" />
  <title>èªéŸ³è¨˜å¸³ï¼ˆFirebase PWAï¼‰</title>
  <link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAB8y0H7AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABNklEQVR42u3RMQEAIAwAsT9fM2lQk1Qm2kB2K2pJrQ9w0gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHgN4Wm9xk8wHq3sJgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP8B0k0Yx8o3P8oAAAAASUVORK5CYII="/>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%230b1020'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='34' fill='%23e8ecff'%3E$%3C/text%3E%3C/svg%3E" />
  <style>
    :root { --bg:#0b1020; --card:#141a2e; --text:#e8ecff; --muted:#9aa3b2; --accent:#6aa5ff; --ok:#49c46b; --warn:#ffb951; --err:#ff6a6a; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;background:linear-gradient(180deg,#0b1020,#0e1530);padding-bottom:env(safe-area-inset-bottom)}
    header{position:sticky;top:0;background:rgba(11,16,32,.85);backdrop-filter:blur(6px);border-bottom:1px solid #1e2745;z-index:10;padding-top:env(safe-area-inset-top)}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid #1e2745;border-radius:16px;padding:16px;color:var(--text);box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .grow{flex:1 1 320px}
    h1{font-size:20px;margin:0;color:var(--text)}
    h2{font-size:18px;margin:8px 0}
    label{display:block;color:var(--muted);margin-top:8px;font-size:13px}
    input,select,textarea{width:100%;padding:12px 14px;background:#0f1529;border:1px solid #233056;border-radius:12px;color:var(--text);font-size:17px}
    textarea{min-height:88px;resize:vertical}
    button{appearance:none;border:1px solid #233056;background:#1a2441;color:var(--text);padding:12px 16px;border-radius:14px;cursor:pointer;min-height:44px;min-width:44px}
    button:hover{filter:brightness(1.06)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .primary{background:linear-gradient(180deg,#2b66ff,#1b46bf);border-color:#2b66ff}
    .ok{background:linear-gradient(180deg,#2a8f51,#1e6f3e);border-color:#2a8f51}
    .warn{background:linear-gradient(180deg,#ce8b2d,#a56b1e);border-color:#ce8b2d}
    .err{background:linear-gradient(180deg,#c83f3f,#9a2c2c);border-color:#c83f3f}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border:1px solid #2a355c;border-radius:999px;background:#0e1530;color:#aeb7d6;font-size:13px;min-height:32px}
    .status-dot{width:8px;height:8px;border-radius:50%}
    .dot-ok{background:var(--ok)} .dot-off{background:#777}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:720px){.grid-2,.grid-3{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid #1f294a;text-align:left;color:#cfd7f0}
    th{color:#8fa1d0;font-weight:600}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New",monospace;background:#0f1529;border:1px solid #233056;border-radius:10px;padding:10px;white-space:pre-wrap}
    details{border:1px solid #233056;border-radius:12px;padding:12px;background:#0f1529}
    summary{cursor:pointer;color:#a7b6e8}
    footer{color:#7f8db2;padding:30px 0}
    small{color:#93a0c7}
  </style>
</head>
<body>
  <header>
    <div class="container row" style="justify-content:space-between;align-items:center">
      <h1>ğŸ™ï¸ èªéŸ³è¨˜å¸³ï¼ˆFirebase PWAï¼‰</h1>
      <div class="row" style="align-items:center;gap:8px">
        <span class="pill"><span id="voiceDot" class="status-dot dot-off"></span> èªéŸ³</span>
        <span class="pill"><span id="authDot" class="status-dot dot-off"></span> ç™»å…¥</span>
        <button id="btnInstall" class="ok" style="display:none">ğŸ“² å®‰è£åˆ°ä¸»ç•«é¢</button>
        <button id="btnSignIn">Google ç™»å…¥</button>
        <button id="btnSignOut" style="display:none">ç™»å‡º</button>
      </div>
    </div>
  </header>

  <main class="container grid" style="margin-top:14px">
    <section class="card grid grid-2">
      <div class="grow">
        <h2>1) èªéŸ³ / æ–‡å­—è¼¸å…¥</h2>
        <div class="row">
          <button class="primary" id="btnToggleRec">é–‹å§‹éŒ„éŸ³</button>
          <button id="btnClear">æ¸…ç©º</button>
          <button id="btnParse">ğŸ§  è§£æ</button>
          <button class="ok" id="btnSave" disabled>âœ… å„²å­˜</button>
        </div>
        <label for="lang">è¾¨è­˜èªè¨€</label>
        <select id="lang">
          <option value="zh-TW">ä¸­æ–‡ï¼ˆå°ç£ï¼‰</option>
          <option value="zh-HK">ä¸­æ–‡ï¼ˆé¦™æ¸¯ï¼‰</option>
          <option value="zh-CN">ä¸­æ–‡ï¼ˆä¸­åœ‹ï¼‰</option>
          <option value="en-US">English (US)</option>
        </select>
        <label for="raw">èªéŸ³è½‰æ–‡å­— / æ‰‹å‹•è¼¸å…¥</label>
        <textarea id="raw" inputmode="text" autocapitalize="off" autocomplete="off" autocorrect="off" placeholder="ä¾‹ï¼šæ˜¨å¤©åœ¨7-11è²·å’–å•¡55å…ƒï¼Œç”¨LINE Pay"></textarea>
        <small class="muted" id="iosHint" style="display:none">ğŸ’¡ iPhoneï¼šè‹¥ä¸Šæ–¹ã€Œé–‹å§‹éŒ„éŸ³ã€ä¸å¯ç”¨ï¼Œè«‹åœ¨éµç›¤ä¸Šé»éº¥å…‹é¢¨ä½¿ç”¨åŸç”ŸèªéŸ³è¼¸å…¥ã€‚</small>
      </div>

      <div class="grow">
        <h2>2) è§£æçµæœï¼ˆå¯ç·¨ä¿®ï¼‰</h2>
        <div class="grid grid-3">
          <div>
            <label>é‡‘é¡ (TWD)</label>
            <input id="amount" type="number" step="0.01" placeholder="0"/>
          </div>
          <div>
            <label>æ—¥æœŸ</label>
            <input id="date" type="date"/>
          </div>
          <div>
            <label>æ™‚é–“</label>
            <input id="time" type="time"/>
          </div>
        </div>
        <div class="grid grid-3">
          <div>
            <label>åº—å®¶ / å°è±¡</label>
            <input id="merchant" placeholder="7-11"/>
          </div>
          <div>
            <label>åˆ†é¡</label>
            <input id="category" placeholder="é¤é£² / äº¤é€š / è¨‚é–±â€¦"/>
          </div>
          <div>
            <label>ä»˜æ¬¾æ–¹å¼</label>
            <input id="payment" placeholder="ç¾é‡‘ / ä¿¡ç”¨å¡ / LINE Payâ€¦"/>
          </div>
        </div>
        <label>å‚™è¨» / åŸå¥</label>
        <textarea id="note"></textarea>
      </div>
    </section>

    <section class="card">
      <h2>3) æŸ¥è©¢èˆ‡åŒ¯å‡º</h2>
      <div class="row" style="align-items:end">
        <div>
          <label>æœˆä»½</label>
          <input id="month" type="month"/>
        </div>
        <button id="btnQuery">ğŸ” è®€å–æœ¬æœˆ</button>
        <button id="btnExport">â¬‡ï¸ åŒ¯å‡ºCSV</button>
        <div class="pill"><span>æœ¬æœˆåˆè¨ˆï¼š</span><strong id="sumMonth">0</strong> å…ƒ</div>
      </div>
      <div style="overflow:auto; max-height:380px; margin-top:10px">
        <table>
          <thead>
            <tr><th>æ—¥æœŸæ™‚é–“</th><th>åº—å®¶</th><th>åˆ†é¡</th><th class="right">é‡‘é¡</th><th>ä»˜æ¬¾</th><th>å‚™è¨»</th></tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>å¿«é€Ÿèªªæ˜</h2>
      <ol>
        <li>æœ¬ç‰ˆæœ¬å·²åµŒå…¥ Firebase è¨­å®šï¼ˆjy-2025ï¼‰ï¼Œé–‹å•Ÿå°±å¯ç”¨ã€‚</li>
        <li>ç™»å…¥ Google å¾Œå³å¯èªéŸ³æˆ–æ‰‹å‹•è¼¸å…¥ï¼ŒæŒ‰ã€ŒğŸ§  è§£æã€â†’ã€Œâœ… å„²å­˜ã€ã€‚</li>
        <li>iOS ä¸æ”¯æ´ Web Speech æ™‚ï¼Œè«‹ç”¨éµç›¤éº¥å…‹é¢¨å£è¿°ã€‚</li>
      </ol>
    </section>

    <footer class="container">
      <small>æç¤ºèªä¾‹ï¼š
        ã€Œä»Šå¤©å…¨è¯è²·èœ 385 å…ƒåˆ·è¯é‚¦å¡ã€ã€
        ã€Œæ˜¨å¤©åœ¨ 7-11 å’–å•¡ 55 å…ƒç”¨ LINE Payã€ã€
        ã€Œ8/3 Uber 220 äº¤é€šã€ã€‚
      </small>
    </footer>
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
  'use strict';
  // ====== iOS & Speech API åµæ¸¬ ======
  const isIOS = /iP(hone|ad|od)/i.test(navigator.userAgent);
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (isIOS && !SR){ document.getElementById('btnToggleRec').style.display='none'; document.getElementById('iosHint').style.display='block'; }

  // ====== Firebase å›ºå®šè¨­å®šï¼ˆjy-2025ï¼‰======
  const firebaseConfig = {
    apiKey: "AIzaSyDeRHsloR1iY0_bzpYbPzdCiBljGfck98k",
    authDomain: "jy-2025.firebaseapp.com",
    projectId: "jy-2025",
    storageBucket: "jy-2025.firebasestorage.app",
    messagingSenderId: "640527461851",
    appId: "1:640527461851:web:eed9f82d698275371fcbfe",
    measurementId: "G-HVEVMTSR9L"
  };
  firebase.initializeApp(firebaseConfig);

  // ====== DOM ======
  const $ = (s)=>document.querySelector(s);
  const btnSignIn = $('#btnSignIn');
  const btnSignOut = $('#btnSignOut');
  const authDot = $('#authDot');
  const voiceDot = $('#voiceDot');
  const btnToggleRec = $('#btnToggleRec');
  const btnClear = $('#btnClear');
  const btnParse = $('#btnParse');
  const btnSave = $('#btnSave');
  const raw = $('#raw');
  const langSel = $('#lang');
  const amount = $('#amount');
  const date = $('#date');
  const time = $('#time');
  const merchant = $('#merchant');
  const category = $('#category');
  const payment = $('#payment');
  const note = $('#note');
  const rows = $('#rows');
  const month = $('#month');
  const btnQuery = $('#btnQuery');
  const btnExport = $('#btnExport');
  const sumMonth = $('#sumMonth');
  const btnInstall = $('#btnInstall');

  // ====== Authï¼ˆiOS èµ° Redirectï¼‰======
  btnSignIn.onclick = async()=>{
    const provider = new firebase.auth.GoogleAuthProvider();
    try{
      if (isIOS) { await firebase.auth().signInWithRedirect(provider); }
      else { await firebase.auth().signInWithPopup(provider); }
    }catch(err){ alert('ç™»å…¥å¤±æ•—ï¼š'+err.message); console.error(err); }
  };
  btnSignOut.onclick = ()=> firebase.auth().signOut();
  firebase.auth().getRedirectResult().catch(err=>console.warn('Redirect error', err));

  firebase.auth().onAuthStateChanged(u=>{
    const on = !!u;
    authDot.className = 'status-dot ' + (on? 'dot-ok':'dot-off');
    btnSignIn.style.display = on? 'none':'inline-block';
    btnSignOut.style.display = on? 'inline-block':'none';
    btnSave.disabled = !on;
    if (on) queryCurrentMonth();
  });

  // ====== èªéŸ³ ======
  let rec; let recognizing = false; let interim = '';
  function setupRecognition(){ if (!SR) return null; const r = new SR(); r.lang = langSel.value || 'zh-TW'; r.continuous = true; r.interimResults = true; r.onstart=()=>{recognizing=true;voiceDot.className='status-dot dot-ok';btnToggleRec.textContent='åœæ­¢éŒ„éŸ³'}; r.onend=()=>{recognizing=false;voiceDot.className='status-dot dot-off';btnToggleRec.textContent='é–‹å§‹éŒ„éŸ³'}; r.onresult=(e)=>{ let finalText=''; for(let i=e.resultIndex;i<e.results.length;i++){ const t=e.results[i][0].transcript; if(e.results[i].isFinal) finalText+=t+' '; else interim=t; } raw.value=(raw.value+' '+finalText).trim(); }; r.onerror=(e)=>console.warn('Speech error', e); return r; }
  btnToggleRec.onclick = ()=>{ if (!rec) rec = setupRecognition(); if (!rec){ alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œè«‹ç”¨éµç›¤éº¥å…‹é¢¨å£è¿°'); return; } if (recognizing) rec.stop(); else { rec.lang = langSel.value; rec.start(); } };
  btnClear.onclick = ()=>{ raw.value=''; };

  // ====== æ–‡å­—è§£æ ======
  function toDateKey(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
  function parseWhen(text){ text=text.trim(); const now=new Date(); const tzNow=new Date(now.toLocaleString('en-US',{timeZone:'Asia/Taipei'})); let d=new Date(tzNow); if(/å‰å¤©/.test(text)) d.setDate(d.getDate()-2); else if (/(æ˜¨|æ˜¨å¤©|æ˜¨æ—¥)/.test(text)) d.setDate(d.getDate()-1); else if(/ä»Šå¤©|ä»Šæ—¥|å‰›å‰›|å‰›æ‰/.test(text)){} else { const mdy=text.match(/(20\d{2})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/); const md=text.match(/(\d{1,2})[\/\-\.æœˆ](\d{1,2})(?:æ—¥)?/); if(mdy){ d=new Date(`${mdy[1]}-${mdy[2]}-${mdy[3]}T12:00:00+08:00`);} else if(md){ const Y=tzNow.getFullYear(); d=new Date(`${Y}-${md[1]}-${md[2]}T12:00:00+08:00`);} } const hm=text.match(/(\d{1,2})[:ï¼š](\d{2})/); if(hm){ d.setHours(parseInt(hm[1],10),parseInt(hm[2],10),0,0);} return d; }
  function parseAmount(text){ const m1=text.match(/(-?\d+[\.,]?\d*)\s*(?:å…ƒ|å¡Š|åœ“)/); if(m1) return parseFloat(m1[1].replace(',','')); const m2=text.match(/(?:NT\$?|æ–°å°å¹£)\s*(-?\d+[\.,]?\d*)/i); if(m2) return parseFloat(m2[1].replace(',','')); const nums=[...text.matchAll(/\b(\d{1,6})(?:\.\d{1,2})?\b/g)].map(x=>x[0]); if(nums.length){ return parseFloat(nums[nums.length-1]); } return NaN; }
  const categoryRules=[{k:/å’–å•¡|é¤|åƒ|ä¾¿ç•¶|æ—©åˆé¤|æ™šé¤|éº¥ç•¶å‹|è‚¯å¾·åŸº|æ˜Ÿå·´å…‹|ç«é‹|é¹½é…¥é›|é£²æ–™|çå¥¶|æ‰‹æ–/i,c:'é¤é£²'},{k:/æ·é‹|å…¬è»Š|è¨ˆç¨‹è»Š|uber|uber\s*eat|æ©Ÿè»Š|æ²¹éŒ¢|åŠ æ²¹|åœè»Š|é«˜éµ|å°éµ|å®¢é‹/i,c:'äº¤é€š'},{k:/7[-â€”]?11|7\s*11|å…¨å®¶|å…¨è¯|å®¶æ¨‚ç¦|costco|é ‚å¥½|ç¾å»‰ç¤¾|æ„›è²·|è¶…å¸‚|ä¾¿åˆ©å•†åº—/i,c:'é›œè²¨'},{k:/æˆ¿ç§Ÿ|ç§Ÿé‡‘|ç®¡ç†è²»|æ°´è²»|é›»è²»|ç“¦æ–¯|ç¬¬å››å°|ç¶²è·¯|å…‰çº–/i,c:'å±…å®¶'},{k:/ç‰™é†«|é†«é™¢|è—¥å±€|å¥ä¿|æ›è™Ÿ|é«”æª¢|çœ‹è¨º|è—¥|å£ç½©/i,c:'é†«ç™‚'},{k:/è¡£|è¤²|é‹|å¤–å¥—|uniqlo|zara|muji|ç„¡å°/i,c:'æœé£¾'},{k:/æ›¸|æ›¸åº—|é›œèªŒ|èª²ç¨‹|å­¸è²»|è£œç¿’|æ•™æ/i,c:'æ•™è‚²'},{k:/netflix|spotify|apple\s*music|youtube\s*premium|è¨‚é–±/i,c:'è¨‚é–±'},{k:/ç¦®ç‰©|ç´…åŒ…|ææ¬¾|å¥‰ç»/i,c:'äººæƒ…'}];
  function detectCategory(text){ for(const r of categoryRules){ if(r.k.test(text)) return r.c; } return ''; }
  function detectPayment(text){ if(/line\s*pay/i.test(text)) return 'LINE Pay'; if(/è¡—å£|JKOPAY/i.test(text)) return 'è¡—å£æ”¯ä»˜'; if(/apple\s*pay/i.test(text)) return 'Apple Pay'; if(/google\s*pay/i.test(text)) return 'Google Pay'; if(/ç¾é‡‘/.test(text)) return 'ç¾é‡‘'; if(/åˆ·å¡|ä¿¡ç”¨å¡|visa|master|jcb/i.test(text)) return 'ä¿¡ç”¨å¡'; if(/è½‰å¸³|åŒ¯æ¬¾/.test(text)) return 'è½‰å¸³'; return ''; }
  function detectMerchant(text){ const m=text.match(/åœ¨([\w\u4e00-\u9fa5\-\s]+?)(?:è²·|åˆ·|ä»˜|æ¶ˆè²»|é»|å–|åƒ)/); if(m) return m[1].trim(); const shops=['7-11','7 11','å…¨å®¶','å…¨è¯','å®¶æ¨‚ç¦','Costco','æ˜Ÿå·´å…‹','éº¥ç•¶å‹','è‚¯å¾·åŸº','é¹½é…¥é›','Uber','Ubereats','Uber eats','Mos','Subway','IKEA']; for(const s of shops){ if(text.toLowerCase().includes(s.toLowerCase())) return s.replace(/\s+/g,''); } return ''; }
  function parseAll(){ const t=(raw.value||'').trim(); if(!t){ alert('è«‹å…ˆè¼¸å…¥èªå¥'); return; } const d=parseWhen(t); const amt=parseAmount(t); const mer=detectMerchant(t); const cat=detectCategory(t); const pay=detectPayment(t); if(!isNaN(amt)) amount.value=amt.toFixed(0); date.value=toDateKey(d); const hh=String(d.getHours()).padStart(2,'0'); const mm=String(d.getMinutes()).padStart(2,'0'); time.value=`${hh}:${mm}`; merchant.value=mer; category.value=cat; payment.value=pay; note.value=t; btnSave.disabled=!firebase.auth().currentUser; }
  btnParse.onclick = parseAll;

  // ====== Firestore ======
  function toTaipeiDate(dateStr, timeStr){ const d=new Date(`${dateStr||new Date().toISOString().slice(0,10)}T${timeStr||'12:00'}:00+08:00`); return d; }
  btnSave.onclick = async()=>{
    if (!firebase.auth().currentUser) { alert('è«‹å…ˆç™»å…¥'); return; }
    const uid = firebase.auth().currentUser.uid;
    const amt = parseFloat(amount.value||'0'); if (!amt || isNaN(amt)) { alert('è«‹è¼¸å…¥é‡‘é¡'); return; }
    const d = toTaipeiDate(date.value, time.value);
    const docData = {
      uid, amount: amt, currency: 'TWD',
      txDate: firebase.firestore.Timestamp.fromDate(d),
      dateKey: toDateKey(d),
      year: d.getFullYear(), month: d.getMonth()+1, day: d.getDate(),
      merchant: merchant.value||'', category: category.value||'', payment: payment.value||'',
      note: note.value||'', source: isIOS? 'ios':'web'
    };
    await firebase.firestore().collection('expenses').add({
      ...docData,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    });
    raw.value=''; amount.value=''; merchant.value=''; category.value=''; payment.value=''; note.value='';
    queryCurrentMonth();
    alert('å·²å„²å­˜');
  };

  function monthRange(ym){ const [y,m]=ym.split('-').map(x=>parseInt(x,10)); const start=new Date(Date.UTC(y,m-1,1,0,0,0)); const end=new Date(Date.UTC(y,m,1,0,0,0)); const fmt=(d)=>d.toISOString().slice(0,10); return {startKey:fmt(start), endKey:fmt(end)}; }
  async function queryByMonth(ym){
    if (!firebase.auth().currentUser) return [];
    const uid = firebase.auth().currentUser.uid;
    const {startKey,endKey}=monthRange(ym);
    const snap = await firebase.firestore().collection('expenses')
      .where('uid','==',uid).where('dateKey','>=',startKey).where('dateKey','<',endKey)
      .orderBy('dateKey','desc').orderBy('txDate','desc').get();
    return snap.docs.map(d=>({id:d.id,...d.data()}));
  }
  function renderRows(list){
    rows.innerHTML=''; let sum=0;
    for (const it of list){
      sum += (it.amount||0);
      const dt = it.txDate?.toDate?.() || new Date();
      const when = `${toDateKey(dt)} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${when}</td><td>${it.merchant||''}</td><td>${it.category||''}</td><td class="right">${(it.amount||0).toLocaleString('zh-TW')}</td><td>${it.payment||''}</td><td class="muted">${(it.note||'').slice(0,60)}</td>`;
      rows.appendChild(tr);
    }
    sumMonth.textContent = sum.toLocaleString('zh-TW');
  }
  async function queryCurrentMonth(){
    const now=new Date();
    const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    month.value = ym;
    const list = await queryByMonth(ym);
    renderRows(list);
  }
  btnQuery.onclick = async()=>{ if(!month.value){ alert('è«‹å…ˆé¸æ“‡æœˆä»½'); return; } const list = await queryByMonth(month.value); renderRows(list); };
  btnExport.onclick = async()=>{
    if (!month.value) { alert('è«‹å…ˆé¸æ“‡æœˆä»½'); return; }
    const list = await queryByMonth(month.value);
    const header = ['æ—¥æœŸ','æ™‚é–“','é‡‘é¡','å¹£åˆ¥','åˆ†é¡','å•†å®¶','ä»˜æ¬¾æ–¹å¼','å‚™è¨»'];
    const lines = [header.join(',')];
    for (const it of list){
      const dt = it.txDate?.toDate?.() || new Date();
      const dateKey = toDateKey(dt);
      const hh = String(dt.getHours()).padStart(2,'0');
      const mm = String(dt.getMinutes()).padStart(2,'0');
      const row = [dateKey, `${hh}:${mm}`, it.amount, it.currency||'TWD', (it.category||''), (it.merchant||''), (it.payment||''), (it.note||'')]
        .map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',');
      lines.push(row);
    }
    const csv = new Blob(["\ufeff"+lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(csv); a.download = `expenses_${month.value}.csv`; a.click();
  };

  // ====== PWAï¼šManifest & Service Worker ======
  (function createManifest(){
    try{
      const manifest = {
        name: "èªéŸ³è¨˜å¸³ï¼ˆFirebaseï¼‰",
        short_name: "èªéŸ³è¨˜å¸³",
        description: "é›¢ç·šå¯ç”¨ã€æ”¯æ´ iOS çš„èªéŸ³è¨˜å¸³ PWA",
        start_url: ".",
        scope: ".",
        display: "standalone",
        background_color: "#0b1020",
        theme_color: "#0b1020",
        icons: [
          { src: document.querySelector("link[rel='apple-touch-icon']").href, sizes: "180x180", type: "image/png", purpose:"any" },
          { src: document.querySelector("link[rel='icon']").href, sizes: "64x64", type: "image/svg+xml", purpose:"any" }
        ]
      };
      const url = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'}));
      const link = document.createElement('link'); link.rel='manifest'; link.href=url; document.head.appendChild(link);
    }catch(e){ console.warn('manifest å»ºç«‹å¤±æ•—', e); }
  })();

  (function registerSW(){
    if (!('serviceWorker' in navigator)) return;
    const swCode = \`
      const CACHE = 'vepwa-v1';
      const ASSETS = [
        './',
        location.pathname,
        'https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js',
        'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js',
        'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js'
      ];
      self.addEventListener('install', e => {
        e.waitUntil((async ()=>{
          const c = await caches.open(CACHE);
          try{ await c.addAll(ASSETS); }catch(err){}
          self.skipWaiting();
        })());
      });
      self.addEventListener('activate', e => {
        e.waitUntil((async()=>{
          const keys = await caches.keys();
          await Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)));
          self.clients.claim();
        })());
      });
      self.addEventListener('fetch', e => {
        const req = e.request;
        if (req.method !== 'GET') return;
        if (req.mode === 'navigate'){
          e.respondWith((async()=>{
            const hit = await caches.match(req, {ignoreSearch:true});
            if (hit) return hit;
            try{ const res = await fetch(req); const c = await caches.open(CACHE); c.put(req, res.clone()); return res; }
            catch(err){ return new Response('<!doctype html><meta charset="utf-8"><title>é›¢ç·šä¸­</title><body style="font-family:sans-serif;padding:20px">é›¢ç·šä½¿ç”¨ä¸­ï¼ˆå·²å¿«å–çš„é é¢å¯ç”¨ï¼‰ã€‚</body>', {headers:{'Content-Type':'text/html;charset=utf-8'}}); }
          })());
        }
      });
    \`;
    const url = URL.createObjectURL(new Blob([swCode], {type:'text/javascript'}));
    navigator.serviceWorker.register(url).catch(err=>console.warn('SW è¨»å†Šå¤±æ•—', err));
  })();

  // å®‰è£æç¤º
  let deferredPrompt = null;
  window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; btnInstall.style.display='inline-block'; });
  btnInstall.onclick = async()=>{
    if (isIOS){ alert('iPhoneï¼šè«‹ç”¨ Safari â†’ åˆ†äº« â†’ åŠ å…¥ä¸»ç•«é¢'); return; }
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
    btnInstall.style.display='none';
  };

  // é è¨­æœˆä»½
  (function initMonth(){ const now=new Date(); month.value = \`\${now.getFullYear()}-\${String(now.getMonth()+1).padStart(2,'0')}\`; })();
  </script>
</body>
</html>
